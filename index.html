<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Stock Manager Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #f4f6f9;
      --card-bg: #ffffff;
      --text-main: #2d3436;
      --text-sub: #636e72;
      --accent-take: #0984e3;
      --accent-add: #00b894;
      --border: #dfe6e9;
      --shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      margin: 0; padding: 0;
      height: 100vh; overflow: hidden;
    }

    .hidden { display: none !important; }
    button { cursor: pointer; border: none; outline: none; -webkit-tap-highlight-color: transparent; }
    
    #view-landing {
      height: 100%; display: flex; flex-direction: column; 
      justify-content: center; align-items: center; padding: 25px; gap: 20px;
    }
    .landing-card {
      width: 100%; max-width: 340px; height: 160px;
      border-radius: 24px; color: white;
      display: flex; flex-direction: column; 
      justify-content: center; align-items: center;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      transition: transform 0.1s;
    }
    .landing-card:active { transform: scale(0.98); }
    .card-take { background: linear-gradient(135deg, #74b9ff, #0984e3); }
    .card-add { background: linear-gradient(135deg, #55efc4, #00b894); }
    .btn-icon { font-size: 32px; margin-bottom: 5px; }
    .btn-label { font-size: 22px; font-weight: 600; }

    #view-app { display: none; height: 100%; flex-direction: column; }
    .app-header {
      padding: 20px; background: var(--card-bg);
      box-shadow: 0 2px 10px rgba(0,0,0,0.03); z-index: 10;
      display: flex; align-items: center; justify-content: space-between;
    }
    .back-btn { background: #f1f2f6; color: var(--text-main); padding: 8px 15px; border-radius: 12px; font-weight: 600; }
    .app-content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 120px; }

    label { font-size: 11px; font-weight: 600; color: var(--text-sub); display: block; margin-top: 15px; text-transform: uppercase; }
    select, input {
      width: 100%; padding: 14px; margin-top: 5px;
      border: 1px solid var(--border); background: var(--card-bg);
      border-radius: 12px; font-size: 15px; box-sizing: border-box;
    }

    #searchResults {
      background: white; border-radius: 12px; margin-top: 5px;
      box-shadow: var(--shadow); max-height: 250px; overflow-y: auto;
      border: 1px solid var(--border);
    }
    .search-item { padding: 12px; border-bottom: 1px solid #f1f2f6; display: flex; justify-content: space-between; align-items: center; }
    .add-new-box { padding: 15px; background: #f8f9fa; border-top: 2px solid var(--accent-add); }

    .cart-card {
      background: white; border-radius: 16px; padding: 15px; margin-top: 12px;
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: var(--shadow);
    }
    .qty-box { display: flex; align-items: center; background: #f1f2f6; border-radius: 10px; padding: 2px; }
    .qty-btn { width: 32px; height: 32px; font-weight: 600; background: transparent; }
    .qty-val { width: 30px; text-align: center; font-weight: 600; }

    .bottom-bar { position: fixed; bottom: 0; left: 0; width: 100%; padding: 20px; background: white; border-top: 1px solid var(--border); box-sizing: border-box; }
    .submit-btn { width: 100%; padding: 16px; border-radius: 14px; font-size: 16px; font-weight: 600; color: white; }
    #loader { position: fixed; inset: 0; background: white; z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
  </style>
</head>
<body>

  <div id="loader">
    <div style="font-size:40px;">ðŸ“¦</div>
    <div style="margin-top:10px; font-weight:600;">Syncing Inventory...</div>
  </div>

  <div id="view-landing" class="hidden">
    <button class="landing-card card-take" onclick="startApp('TAKE')">
      <span class="btn-icon">ðŸ“¤</span>
      <span class="btn-label">Take Item</span>
    </button>
    <button class="landing-card card-add" onclick="startApp('ADD')">
      <span class="btn-icon">ðŸ“¥</span>
      <span class="btn-label">Add Stock</span>
    </button>
  </div>

  <div id="view-app">
    <div class="app-header">
      <button class="back-btn" onclick="goHome()">Back</button>
      <span id="page-title" style="font-weight:600;">Request</span>
      <div style="width:50px"></div>
    </div>

    <div class="app-content">
      <label>Staff Member</label>
      <select id="userSelect"></select>

      <label>Purpose</label>
      <input type="text" id="purpose" placeholder="e.g., Event Setup">

      <hr style="margin:20px 0; border:0; border-top: 1px dashed #ccc;">

      <label>Search or Create Item</label>
      <input type="text" id="searchInput" placeholder="Search item name..." autocomplete="off">
      <div id="searchResults" class="hidden"></div>

      <div id="cartList"></div>
    </div>

    <div class="bottom-bar">
      <button id="mainBtn" class="submit-btn" onclick="submitData()">Confirm</button>
    </div>
  </div>

<script>
  // Replace with your Web App URL
  const API_URL = "https://script.google.com/macros/s/AKfycbw19CSN1OxuYTycvFltEEN6CH-W6wTFn0dCYwLwmkEuqWbUHcIPSF7axfGAONA3YxqR/exec"; 

  const STAFF_LIST = [
    { name: "Ahmed", email: "ahmed.tanany@sirkil.com" },
    { name: "Abdullah", email: "abdallah.yahya@sirkil.com" },
    { name: "Omar", email: "omar@sirkil.com" },
    { name: "Amr", email: "amr@example.com" }
  ];

  let inventory = [];
  let cart = [];
  let MODE = "";

  window.onload = async () => {
    const sel = document.getElementById("userSelect");
    STAFF_LIST.forEach(u => sel.add(new Option(u.name, u.email)));
    loadData();
  };

  async function loadData() {
    try {
      const res = await fetch(API_URL);
      inventory = await res.json();
      document.getElementById("loader").classList.add("hidden");
      document.getElementById("view-landing").classList.remove("hidden");
    } catch(e) {
      document.getElementById("loader").innerHTML = "Error loading data.";
    }
  }

  function startApp(mode) {
    MODE = mode;
    document.getElementById("view-landing").classList.add("hidden");
    document.getElementById("view-app").style.display = "flex";
    const btn = document.getElementById("mainBtn");
    document.getElementById("page-title").innerText = mode === 'ADD' ? "Add to Stock" : "Take from Stock";
    btn.style.background = mode === 'ADD' ? "#00b894" : "#0984e3";
  }

  function goHome() {
    document.getElementById("view-app").style.display = "none";
    document.getElementById("view-landing").classList.remove("hidden");
    cart = [];
    renderCart();
  }

  const searchInput = document.getElementById("searchInput");
  const resultsDiv = document.getElementById("searchResults");

  searchInput.addEventListener("input", () => {
    const q = searchInput.value.toLowerCase();
    resultsDiv.innerHTML = "";
    if (q.length < 1) { resultsDiv.classList.add("hidden"); return; }

    const matches = inventory.filter(i => i.name.toLowerCase().includes(q));
    resultsDiv.classList.remove("hidden");

    matches.forEach(item => {
      const div = document.createElement("div");
      div.className = "search-item";
      div.innerHTML = `<div><b>${item.name}</b><br><small>${item.category}</small></div>
                       <button class="back-btn" style="background:var(--text-main); color:white;" onclick="addToCart('${item.name}', '${item.category}')">ADD</button>`;
      resultsDiv.appendChild(div);
    });

    if (MODE === "ADD") {
      const addNew = document.createElement("div");
      addNew.className = "add-new-box";
      const categories = [...new Set(inventory.map(i => i.category))];
      addNew.innerHTML = `
        <div style="font-size:12px; margin-bottom:5px;"><b>NEW ITEM:</b> "${searchInput.value}"</div>
        <select id="newSheetSel" style="padding:8px; font-size:12px;">
          <option value="">-- Choose Sheet --</option>
          ${categories.map(c => `<option value="${c}">${c}</option>`).join('')}
          <option value="NEW">+ Create New Sheet</option>
        </select>
        <input type="text" id="customSheet" class="hidden" placeholder="Sheet Name..." style="padding:8px; margin-top:5px; font-size:12px;">
        <button onclick="addNewItem()" style="width:100%; margin-top:10px; background:var(--accent-add); color:white; padding:10px; border-radius:8px; font-weight:600;">Create & Add</button>
      `;
      resultsDiv.appendChild(addNew);
      
      document.getElementById('newSheetSel').addEventListener('change', (e) => {
        document.getElementById('customSheet').classList.toggle('hidden', e.target.value !== 'NEW');
      });
    }
  });

  function addNewItem() {
    const name = searchInput.value;
    let sheet = document.getElementById('newSheetSel').value;
    if (sheet === 'NEW') sheet = document.getElementById('customSheet').value;
    if (!name || !sheet) return alert("Enter name and select sheet");
    addToCart(name, sheet);
  }

  function addToCart(name, category) {
    const existing = cart.find(c => c.name === name && c.category === category);
    if(existing) existing.qty++;
    else cart.push({ name, category, qty: 1 });
    renderCart();
    searchInput.value = "";
    resultsDiv.classList.add("hidden");
  }

  function renderCart() {
    const list = document.getElementById("cartList");
    list.innerHTML = "";
    cart.forEach((item, idx) => {
      const div = document.createElement("div");
      div.className = "cart-card";
      div.innerHTML = `<div><b>${item.name}</b><br><small>${item.category}</small></div>
        <div class="qty-box">
          <button class="qty-btn" onclick="modQty(${idx},-1)">âˆ’</button>
          <span class="qty-val">${item.qty}</span>
          <button class="qty-btn" onclick="modQty(${idx},1)">+</button>
        </div>`;
      list.appendChild(div);
    });
  }

  function modQty(idx, d) {
    cart[idx].qty += d;
    if(cart[idx].qty <= 0) cart.splice(idx,1);
    renderCart();
  }

  async function submitData() {
    if(!cart.length || !document.getElementById("purpose").value) return alert("Fill all fields");
    const btn = document.getElementById("mainBtn");
    btn.disabled = true; btn.innerText = "Processing...";
    
    const payload = {
      type: MODE,
      purpose: document.getElementById("purpose").value,
      user: { name: document.getElementById("userSelect").selectedOptions[0].text, email: document.getElementById("userSelect").value },
      cart: cart
    };

    try {
      await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
      alert("Success!");
      location.reload();
    } catch(e) {
      alert("Error saving.");
      btn.disabled = false;
    }
  }
</script>
</body>
</html>
