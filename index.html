<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Stock Manager Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root { --bg-color: #f4f6f9; --card-bg: #ffffff; --text-main: #2d3436; --accent-take: #0984e3; --accent-add: #00b894; --border: #dfe6e9; }
    body { font-family: 'Poppins', sans-serif; background: var(--bg-color); color: var(--text-main); margin: 0; overflow: hidden; height: 100vh; }
    .hidden { display: none !important; }
    button { cursor: pointer; border: none; outline: none; -webkit-tap-highlight-color: transparent; }
    #view-landing { height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 25px; gap: 20px; }
    .landing-card { width: 100%; max-width: 340px; height: 160px; border-radius: 24px; color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
    .card-take { background: linear-gradient(135deg, #74b9ff, #0984e3); }
    .card-add { background: linear-gradient(135deg, #55efc4, #00b894); }
    #view-app { display: none; height: 100%; flex-direction: column; }
    .app-header { padding: 20px; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.03); display: flex; align-items: center; justify-content: space-between; }
    .app-content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 120px; }
    input, select { width: 100%; padding: 14px; margin-top: 5px; border: 1px solid var(--border); border-radius: 12px; font-size: 15px; box-sizing: border-box; }
    #searchResults { background: white; border-radius: 12px; margin-top: 5px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); max-height: 250px; overflow-y: auto; border: 1px solid var(--border); }
    .search-item { padding: 12px; border-bottom: 1px solid #f1f2f6; display: flex; justify-content: space-between; align-items: center; }
    .cart-card { background: white; border-radius: 16px; padding: 15px; margin-top: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .qty-box { display: flex; align-items: center; background: #f1f2f6; border-radius: 10px; padding: 4px; }
    .qty-btn { width: 32px; height: 32px; font-weight: 600; background: transparent; }
    .qty-input { width: 55px; text-align: center; border: none; background: transparent; font-weight: 600; font-size: 16px; outline: none; }
    .qty-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .bottom-bar { position: fixed; bottom: 0; left: 0; width: 100%; padding: 20px; background: white; border-top: 1px solid var(--border); box-sizing: border-box; }
    .submit-btn { width: 100%; padding: 16px; border-radius: 14px; font-size: 16px; font-weight: 600; color: white; }
    #loader { position: fixed; inset: 0; background: white; z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
  </style>
</head>
<body>

  <div id="loader">ðŸ“¦ Loading System...</div>

  <div id="view-landing" class="hidden">
    <button class="landing-card card-take" onclick="startApp('TAKE')">ðŸ“¤ Take Item</button>
    <button class="landing-card card-add" onclick="startApp('ADD')">ðŸ“¥ Add Stock</button>
  </div>

  <div id="view-app">
    <div class="app-header"><button onclick="goHome()">Back</button><span id="page-title"></span><div style="width:50px"></div></div>
    <div class="app-content">
      <label>Staff Member</label><select id="userSelect"></select>
      <label>Purpose</label><input type="text" id="purpose" placeholder="Reason...">
      <hr><label>Search Item</label><input type="text" id="searchInput" placeholder="Type name..." autocomplete="off">
      <div id="searchResults" class="hidden"></div>
      <div id="cartList"></div>
    </div>
    <div class="bottom-bar"><button id="mainBtn" class="submit-btn" onclick="submitData()">Confirm</button></div>
  </div>

<script>
  // UPDATE YOUR URL HERE
  const API_URL = "https://script.google.com/macros/s/AKfycbw7NwN9DvobdnSFywHpFvwI2W4ze3uRabZvMzJsiSxxzQ0kZzAGoyPY75dU27ATIQ4r/exec"; 

  const STAFF_LIST = [{name:"Ahmed",email:"ahmed.tanany@sirkil.com"},{name:"Abdullah",email:"abdallah.yahya@sirkil.com"},{name:"Omar",email:"omar@sirkil.com"}];
  let inventory = [], cart = [], MODE = "";

  window.onload = async () => {
    const sel = document.getElementById("userSelect");
    STAFF_LIST.forEach(u => sel.add(new Option(u.name, u.email)));
    try {
      const res = await fetch(API_URL);
      inventory = await res.json();
      document.getElementById("loader").classList.add("hidden");
      document.getElementById("view-landing").classList.remove("hidden");
    } catch(e) { alert("Failed to connect to script."); }
  };

  function startApp(mode) {
    MODE = mode;
    document.getElementById("view-landing").classList.add("hidden");
    document.getElementById("view-app").style.display = "flex";
    document.getElementById("mainBtn").style.background = mode==='ADD'?"#00b894":"#0984e3";
  }

  function goHome() { document.getElementById("view-app").style.display = "none"; document.getElementById("view-landing").classList.remove("hidden"); cart=[]; renderCart(); }

  searchInput.addEventListener("input", () => {
    const q = searchInput.value.toLowerCase();
    resultsDiv.innerHTML = "";
    if (q.length < 1) { resultsDiv.classList.add("hidden"); return; }
    const matches = inventory.filter(i => i.name.toLowerCase().includes(q));
    resultsDiv.classList.remove("hidden");
    matches.forEach(item => {
      const div = document.createElement("div"); div.className = "search-item";
      div.innerHTML = `<div><b>${item.name}</b><br><small>${item.category}</small></div><button onclick="addToCart('${item.name}','${item.category}')">ADD</button>`;
      resultsDiv.appendChild(div);
    });
    if (MODE === "ADD") {
      const div = document.createElement("div"); div.style.padding="10px";
      div.innerHTML = `<button onclick="addToCart('${searchInput.value}','NewSheet')" style="width:100%; background:#eee;">+ Create New Item</button>`;
      resultsDiv.appendChild(div);
    }
  });

  function addToCart(name, cat) {
    const ex = cart.find(c => c.name === name && c.category === cat);
    if(ex) ex.qty++; else cart.push({name, category:cat, qty:1});
    renderCart(); searchInput.value = ""; resultsDiv.classList.add("hidden");
  }

  function renderCart() {
    const list = document.getElementById("cartList");
    list.innerHTML = "";
    cart.forEach((item, idx) => {
      const div = document.createElement("div"); div.className = "cart-card";
      div.innerHTML = `<div><b>${item.name}</b><br><small>${item.category}</small></div>
        <div class="qty-box">
          <button class="qty-btn" onclick="updateQty(${idx},-1)">âˆ’</button>
          <input type="number" class="qty-input" value="${item.qty}" onchange="manualQty(${idx},this.value)">
          <button class="qty-btn" onclick="updateQty(${idx},1)">+</button>
        </div>`;
      list.appendChild(div);
    });
  }

  function manualQty(idx, val) { cart[idx].qty = parseInt(val) || 1; renderCart(); }
  function updateQty(idx, d) { cart[idx].qty = Math.max(1, cart[idx].qty + d); renderCart(); }

  async function submitData() {
    if(!cart.length || !document.getElementById("purpose").value) return alert("Fill all fields");
    const btn = document.getElementById("mainBtn");
    btn.disabled = true; btn.innerText = "Processing...";
    const payload = { type: MODE, purpose: document.getElementById("purpose").value, user: { name: userSelect.options[userSelect.selectedIndex].text }, cart: cart };
    try {
      await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
      alert("Success!"); location.reload();
    } catch(e) { alert("Error."); btn.disabled = false; }
  }
</script>
</body>
</html>
